<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å‘³ä¾¿ç•¶ - ç·šä¸Šè¨‚è³¼ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #e67e22; --light: #fdfaf6; --dark: #333; --success: #27ae60; --danger: #e74c3c; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; margin: 0; background: var(--light); color: var(--dark); padding-bottom: 100px; }
        
        /* é é¦–èˆ‡ç‹€æ…‹ */
        header { background: var(--primary); color: white; padding: 1rem; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .status-badge { font-size: 12px; padding: 5px 12px; border-radius: 20px; background: rgba(255,255,255,0.2); margin-top: 8px; display: inline-block; }
        
        /* é®ç½©æ¨£å¼ */
        .hidden { display: none !important; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; display: flex; align-items: center; justify-content: center; z-index: 1000; text-align: center; padding: 20px; box-sizing: border-box; }

        .container { padding: 15px; max-width: 600px; margin: 0 auto; }
        .product-card { background: white; border-radius: 12px; display: flex; padding: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); align-items: center; }
        .product-img { width: 90px; height: 90px; border-radius: 10px; object-fit: cover; border: 1px solid #eee; }
        .product-info { flex: 1; padding-left: 15px; }
        .product-name { font-weight: bold; font-size: 18px; margin: 0; color: #333; }
        .product-price { color: var(--primary); font-weight: bold; font-size: 16px; margin: 5px 0; }
        
        /* æ•¸é‡æ§åˆ¶å™¨ */
        .stepper { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .stepper button { width: 32px; height: 32px; border-radius: 50%; border: 1px solid #ddd; background: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .stepper span { font-weight: bold; font-size: 18px; min-width: 25px; text-align: center; }

        /* è¨‚è³¼è¡¨å–® */
        .form-card { background: white; padding: 20px; border-radius: 12px; margin-top: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .form-card h3 { margin: 0 0 15px 0; color: var(--primary); }
        .input-group { margin-bottom: 12px; }
        .input-group label { display: block; font-size: 14px; margin-bottom: 5px; color: #666; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }

        /* ç¢ºèªè¨‚å–® å½ˆçª— (äºŒæ¬¡ç¢ºèªåŠŸèƒ½) */
        .confirm-modal { background: white; color: #333; width: 95%; max-width: 400px; border-radius: 15px; padding: 25px; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .confirm-modal h2 { color: var(--primary); margin-top: 0; text-align: center; font-size: 20px; }
        .confirm-list { margin: 15px 0; border-top: 1px dashed #ddd; border-bottom: 1px dashed #ddd; padding: 10px 0; max-height: 200px; overflow-y: auto; }
        .confirm-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 16px; }
        .confirm-btns { display: grid; grid-template-columns: 1fr 1.5fr; gap: 10px; margin-top: 20px; }
        .btn-cancel { background: #eee; color: #666; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-confirm { background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* åº•éƒ¨æ¬„ */
        .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; padding: 15px 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 200; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .total-amount { font-size: 22px; font-weight: bold; color: var(--primary); }
        .btn-order { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-order:disabled { background: #ccc; }
    </style>
</head>
<body>

    <div id="closed-msg" class="overlay hidden">
        <div>
            <h2 style="color: var(--primary);">ç›®å‰éè¨‚è³¼æ™‚æ®µ ğŸ±</h2>
            <p id="open-time-hint" style="line-height: 1.6;"></p>
        </div>
    </div>

    <div id="confirm-overlay" class="overlay hidden">
        <div class="confirm-modal">
            <h2>æ ¸å°è¨‚å–®å…§å®¹</h2>
            <div id="confirm-user-info" style="font-size: 14px; color: #666; margin-bottom: 10px; background: #f9f9f9; padding: 8px; border-radius: 4px;"></div>
            <div class="confirm-list" id="confirm-items-list">
                </div>
            <div style="text-align: right; font-size: 20px; font-weight: bold; margin-top: 10px;">
                åˆè¨ˆï¼šNT$ <span id="confirm-total-val">0</span>
            </div>
            <div class="confirm-btns">
                <button class="btn-cancel" onclick="closeConfirmModal()">å›é ­ä¿®æ”¹</button>
                <button class="btn-confirm" id="final-submit-btn" onclick="realSubmitOrder()">ç¢ºèªç„¡èª¤ï¼Œé€å‡º</button>
            </div>
        </div>
    </div>

    <header>
        <h1 style="margin:0; font-size: 22px;">ğŸ± ç¾å‘³ä¾¿ç•¶åº—</h1>
        <div id="status-text" class="status-badge">åŒæ­¥ç‡Ÿæ¥­ç‹€æ…‹ä¸­...</div>
    </header>

    <div class="container">
        <div id="product-list"></div>

        <div class="form-card">
            <h3>è¨‚è³¼äººè³‡è¨Š</h3>
            <div class="input-group"><label>å–é¤äººå§“å</label><input type="text" id="cust-name" placeholder="è«‹å¡«å¯«å§“å"></div>
            <div class="input-group"><label>è¯çµ¡é›»è©±</label><input type="tel" id="cust-phone" placeholder="è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼"></div>
            <div class="input-group"><label>å‚™è¨» (é¸å¡«)</label><input type="text" id="cust-note" placeholder="ä¾‹å¦‚ï¼šé£¯å°‘ã€ä¸è¾£"></div>
        </div>
    </div>

    <div class="footer-bar">
        <div class="total-amount">NT$ <span id="total-val">0</span></div>
        <button id="submit-btn" class="btn-order" onclick="showConfirmModal()">é€å‡ºè¨‚å–®</button>
    </div>

    <script>
        // === 1. é…ç½®è¨­å®š ===
       const SUPABASE_URL = 'https://jizwmppcyjyhmrvrdwqi.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppendtcHBjeWp5aG1ydnJkd3FpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjA3MTAsImV4cCI6MjA3NjEzNjcxMH0.H5I0Z-l9cA7g39ZhwAKJ25Y9svIuL86HCqGnNL4ADzM'; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let products = [];
        let cart = {}; 

        // --- 2. æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹ (è§£æ±ºé®ç½©è¡çª) ---
        async function checkBusinessStatus() {
            const now = new Date();
            const day = now.getDay(); 
            const currentTime = now.toTimeString().split(' ')[0]; // æ ¼å¼ HH:mm:ss

            const { data: schedule } = await supabaseClient.from('store_schedule').select('*').eq('day_of_week', day).single();

            const closedMsg = document.getElementById('closed-msg');
            const submitBtn = document.getElementById('submit-btn');
            const statusText = document.getElementById('status-text');

            const isOpen = schedule && schedule.is_enabled && currentTime >= schedule.open_time && currentTime <= schedule.close_time;

            if (isOpen) {
                closedMsg.classList.add('hidden'); // ç‡Ÿæ¥­ä¸­å‹™å¿…éš±è—é®ç½©
                submitBtn.disabled = false;
                statusText.innerText = `â— ç‡Ÿæ¥­ä¸­ (${schedule.open_time.slice(0,5)}-${schedule.close_time.slice(0,5)})`;
                statusText.style.background = "rgba(39, 174, 96, 0.4)";
                return true;
            } else {
                closedMsg.classList.remove('hidden'); // éç‡Ÿæ¥­ä¸­é¡¯ç¤ºé®ç½©
                document.getElementById('open-time-hint').innerText = (schedule && schedule.is_enabled) 
                    ? `ä»Šæ—¥é–‹æ”¾æ™‚æ®µï¼š\n${schedule.open_time.slice(0,5)} - ${schedule.close_time.slice(0,5)}` 
                    : "ä»Šæ—¥å…¬ä¼‘ä¸­";
                submitBtn.disabled = true;
                statusText.innerText = "â—‹ éç‡Ÿæ¥­æ™‚æ®µ";
                statusText.style.background = "rgba(231, 76, 60, 0.4)";
                return false;
            }
        }

        // --- 3. ç”¢å“è¼‰å…¥ ---
        async function fetchProducts() {
            const { data } = await supabaseClient.from('products').select('*').eq('is_active', true).order('price');
            products = data;
            const list = document.getElementById('product-list');
            list.innerHTML = products.map(p => `
                <div class="product-card">
                    <img src="${p.image_url}" class="product-img">
                    <div class="product-info">
                        <p class="product-name">${p.name}</p>
                        <p class="product-price">NT$ ${p.price}</p>
                        <div class="stepper">
                            <button onclick="updateQty('${p.id}', -1)">-</button>
                            <span id="qty-${p.id}">0</span>
                            <button onclick="updateQty('${p.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateQty(pid, delta) {
            const current = cart[pid] || 0;
            const next = Math.max(0, current + delta);
            cart[pid] = next;
            document.getElementById(`qty-${pid}`).innerText = next;
            let total = 0;
            products.forEach(p => { if (cart[p.id]) total += p.price * cart[p.id]; });
            document.getElementById('total-val').innerText = total;
        }

        // --- 4. äºŒæ¬¡ç¢ºèª Modal é‚è¼¯ ---
        function showConfirmModal() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const total = parseInt(document.getElementById('total-val').innerText);

            if (!name || !phone) { alert("è«‹å¡«å¯«å–é¤äººå§“åèˆ‡é›»è©±"); return; }
            if (total === 0) { alert("è«‹å…ˆé¸æ“‡ä¾¿ç•¶å“é …"); return; }

            // ç”Ÿæˆç¢ºèªæ¸…å–®
            let itemsHtml = "";
            products.forEach(p => {
                if (cart[p.id] > 0) {
                    itemsHtml += `<div class="confirm-item"><span>${p.name} x ${cart[p.id]}</span><span>$${p.price * cart[p.id]}</span></div>`;
                }
            });

            document.getElementById('confirm-user-info').innerHTML = `<b>å–é¤äººï¼š</b>${name}<br><b>é›»è©±ï¼š</b>${phone}`;
            document.getElementById('confirm-items-list').innerHTML = itemsHtml;
            document.getElementById('confirm-total-val').innerText = total;
            document.getElementById('confirm-overlay').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-overlay').classList.add('hidden');
        }

        // --- 5. æ­£å¼ä¸‹å–® ---
        async function realSubmitOrder() {
            const name = document.getElementById('cust-name').value;
            const phone = document.getElementById('cust-phone').value;
            const note = document.getElementById('cust-note').value;
            const total = parseInt(document.getElementById('total-val').innerText);
            const btn = document.getElementById('final-submit-btn');

            btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";

            try {
                // A. å»ºç«‹è¨‚å–®
                const { data: order, error: orderErr } = await supabaseClient.from('orders').insert([
                    { customer_name: name, customer_phone: phone, note: note, total_amount: total, status: 'pending' }
                ]).select().single();

                if (orderErr) throw orderErr;

                // B. å»ºç«‹æ˜ç´°
                const items = products.filter(p => cart[p.id] > 0).map(p => ({
                    order_id: order.id,
                    product_id: p.id,
                    quantity: cart[p.id],
                    unit_price: p.price
                }));

                const { error: itemErr } = await supabaseClient.from('order_items').insert(items);
                if (itemErr) throw itemErr;

                alert("ğŸ‰ è¨‚è³¼æˆåŠŸï¼è«‹æº–æ™‚å‰ä¾†å–é¤ã€‚");
                location.reload(); 
            } catch (err) {
                alert("ä¸‹å–®å¤±æ•—ï¼š" + err.message);
                btn.disabled = false; btn.innerText = "é‡æ–°é€å‡º";
            }
        }

        window.onload = async () => { 
            const isOpen = await checkBusinessStatus(); 
            if (isOpen) await fetchProducts(); 
        };
    </script>
</body>
</html>